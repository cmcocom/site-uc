---
import "../styles/globals.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { ViewTransitions } from "astro:transitions";

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
}

const {
  title = "Unidad C - Soluciones Tecnológicas",
  description = "Unidad C - Soluciones tecnológicas y de consultoría para tu negocio",
  ogImage = "/images/logo_uc_orange_hd.svg",
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, "https://unidadc.com");
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="canonical" href={canonicalURL.href} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <meta name="generator" content={Astro.generator} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL.href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, "https://unidadc.com").href} />
    <meta property="og:locale" content="es_MX" />
    <meta property="og:site_name" content="Unidad C" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, "https://unidadc.com").href} />

    <ViewTransitions />
    <title>{title}</title>
  </head>
  <body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen">
    <Header />
    <main>
      <slot />
    </main>
    <Footer />

    <!-- WhatsApp Floating Button -->
    <a
      href="https://wa.me/525660000199"
      target="_blank"
      rel="noopener noreferrer"
      aria-label="Contactar por WhatsApp"
      class="fixed bottom-6 right-6 z-50 flex h-14 w-14 items-center justify-center rounded-full bg-[#25D366] shadow-lg transition-transform hover:scale-110 hover:shadow-xl"
    >
      <svg viewBox="0 0 32 32" class="h-8 w-8 fill-white">
        <path d="M16.004 0h-.008C7.174 0 0 7.176 0 16c0 3.5 1.13 6.742 3.046 9.378L1.054 31.29l6.156-1.952C9.77 31.076 12.76 32 16.004 32 24.826 32 32 24.822 32 16S24.826 0 16.004 0zm9.35 22.606c-.39 1.1-1.932 2.014-3.164 2.28-.844.18-1.946.322-5.656-1.216-4.746-1.966-7.804-6.78-8.04-7.094-.226-.314-1.9-2.53-1.9-4.826s1.2-3.424 1.628-3.892c.428-.468.934-.586 1.246-.586.312 0 .624.002.896.016.288.014.674-.11 1.054.804.39.938 1.326 3.234 1.444 3.468.116.234.194.508.04.82-.156.312-.234.508-.468.782-.234.274-.492.614-.702.824-.234.234-.478.488-.206.958.274.468 1.216 2.006 2.61 3.25 1.792 1.6 3.302 2.096 3.77 2.33.468.234.742.194 1.016-.118.274-.312 1.17-1.364 1.482-1.832.312-.468.624-.39 1.054-.234.428.156 2.724 1.286 3.192 1.52.468.234.78.352.896.546.116.196.116 1.13-.274 2.228z"/>
      </svg>
    </a>

    <script is:inline define:vars={{ banxicoToken: import.meta.env.BANXICO_TOKEN || "b30025859cf0d83719bfedbe2779b3efc325f22ebed53fdcfaa32ba357ec6746" }}>
      const fetchBanxicoRate = async () => {
        try {
          const token = banxicoToken;
          if (!token) return;

          const today = new Date();
          const threeDaysAgo = new Date(today);
          threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

          const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
          };

          const url = `https://www.banxico.org.mx/SieAPIRest/service/v1/series/SF43718/datos/${formatDate(threeDaysAgo)}/${formatDate(today)}?token=${token}`;
          const response = await fetch(url);

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();

          if (data.bmx?.series?.[0]?.datos?.length > 0) {
            const latestData = data.bmx.series[0].datos[data.bmx.series[0].datos.length - 1];
            const rate = parseFloat(latestData.dato).toFixed(4);
            const rateElement = document.getElementById("header-rate-value");
            const dateElement = document.getElementById("header-date-value");
            if (rateElement) rateElement.textContent = rate;
            if (dateElement) dateElement.textContent = latestData.fecha;
          } else {
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekUrl = `https://www.banxico.org.mx/SieAPIRest/service/v1/series/SF43718/datos/${formatDate(weekAgo)}/${formatDate(today)}?token=${token}`;

            try {
              const weekResponse = await fetch(weekUrl);
              if (weekResponse.ok) {
                const weekData = await weekResponse.json();
                if (weekData.bmx?.series?.[0]?.datos?.length > 0) {
                  const availableData = weekData.bmx.series[0].datos;
                  const latestData = availableData[availableData.length - 1];
                  const rate = parseFloat(latestData.dato).toFixed(4);
                  const rateElement = document.getElementById("header-rate-value");
                  const dateElement = document.getElementById("header-date-value");
                  if (rateElement) rateElement.textContent = rate;
                  if (dateElement) dateElement.textContent = latestData.fecha;
                  return;
                }
              }
            } catch { /* silencioso */ }

            const rateElement = document.getElementById("header-rate-value");
            if (rateElement) {
              rateElement.textContent = "Sin datos";
              rateElement.parentElement?.classList.add("text-red-400");
            }
          }
        } catch {
          const rateElement = document.getElementById("header-rate-value");
          const container = rateElement?.parentElement;
          if (rateElement) rateElement.textContent = "Error";
          if (container) container.classList.add("text-red-400");
        }
      };

      let banxicoInterval;

      const initBanxicoRate = () => {
        const rateElement = document.getElementById("header-rate-value");
        if (rateElement) {
          if (banxicoInterval) clearInterval(banxicoInterval);
          fetchBanxicoRate();
          banxicoInterval = setInterval(fetchBanxicoRate, 30 * 60 * 1000);
        }
      };

      initBanxicoRate();
      document.addEventListener("astro:page-load", initBanxicoRate);
    </script>
  </body>
</html>
